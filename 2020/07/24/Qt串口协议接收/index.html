<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Home Page</title><meta name="author" content="Liu Junzhuo"><link rel="shortcut icon" href="/img/favicon.png"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.13.0/css/all.min.css"><meta name="generator" content="Hexo 5.4.0"></head><body><header id="page_header"><div class="header_wrap"><div id="blog_name"><a class="blog_title" id="site-name" href="/">Home Page</a></div><button class="menus_icon"><div class="navicon"></div></button><ul class="menus_items"><li class="menus_item"><a class="site-page" href="/projects-works"> Projects &amp; Works</a></li></ul></div></header><main id="page_main"><div class="side-card sticky"><div class="card-wrap" itemscope itemtype="http://schema.org/Person"><div class="author-avatar"><img class="avatar-img" src="/img/IMG_20190825_153137.jpg" onerror="this.onerror=null;this.src='/img/profile.png'" alt="avatar"></div><div class="author-discrip"><h3>Liu Junzhuo</h3><p class="author-bio">An undergraduate from NWPU, major in Detection, Guidance and Control Techniques</p></div><div class="author-links"><button class="btn m-social-links">Links</button><ul class="social-icons"><li><a class="social-icon" href="https://github.com/Excitingship" target="_blank"><i class="fab fa-github" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-weixin" aria-hidden="true"></i></a></li><li><a class="social-icon" href="/" target="_blank"><i class="fab fa-qq" aria-hidden="true"></i></a></li></ul><ul class="social-links"><li><a class="e-social-link" href="/" target="_blank"><i class="fas fa-graduation-cap" aria-hidden="true"></i><span>Google Scholar</span></a></li><li><a class="e-social-link" href="/" target="_blank"><i class="fab fa-orcid" aria-hidden="true"></i><span>ORCID</span></a></li></ul></div><a class="cv-links" href="/attaches/CV.pdf" target="_blank"><i class="fas fa-file-pdf" aria-hidden="true"><span>My Detail CV.</span></i></a></div></div><div class="page" itemscope itemtype="http://schema.org/CreativeWork"><h2 class="page-title">Qt串口协议接收</h2><article><h1 id="Qt串口协议接收"><a href="#Qt串口协议接收" class="headerlink" title="Qt串口协议接收"></a>Qt串口协议接收</h1><p><em>在做一个机械臂的地面站（为了方便调试）时用到了Qt，简单学习之后完成了大部分内容，但是串口接收协议时总是丢包，后来在学长的点拨下试着用有穷自动机写了串口数据的处理部分，效果有很大提升。</em></p>
<h2 id="Qt对串口的访问"><a href="#Qt对串口的访问" class="headerlink" title="Qt对串口的访问"></a>Qt对串口的访问</h2><p>只需要在头文件中包含QSerialPort和QSerialPortInfo即可，QSerialPort是Qt自带的串口访问模块,是QIODevice类的子类。</p>
<p>MainWindow.h</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QMainWindow&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSerialPort&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QSerialPortInfo&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MainWindow</span> :</span> <span class="keyword">public</span> QMainWindow</span><br><span class="line">&#123;</span><br><span class="line">    Q_OBJECT</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MainWindow</span>(QWidget *parent = <span class="literal">nullptr</span>);</span><br><span class="line">    ~<span class="built_in">MainWindow</span>();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Ui::MainWindow *ui;</span><br><span class="line">    QSerialPort sp; <span class="comment">//启动窗口后实例化</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>MainWindow.cpp</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::on_com_ctrl_clicked</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>-&gt;ui-&gt;com_ctrl-&gt;<span class="built_in">text</span>() == <span class="string">&quot;打开串口&quot;</span>)   <span class="comment">//初始状态，配置串口参数</span></span><br><span class="line">    &#123;</span><br><span class="line">        sp.<span class="built_in">setPortName</span>(ui-&gt;com_set-&gt;<span class="built_in">currentText</span>());     <span class="comment">//设置串口号、</span></span><br><span class="line">        sp.<span class="built_in">setBaudRate</span>(ui-&gt;baudrate_set-&gt;<span class="built_in">currentText</span>().<span class="built_in">toInt</span>());    <span class="comment">//设置波特率</span></span><br><span class="line">        sp.<span class="built_in">setDataBits</span>(QSerialPort::Data8);     <span class="comment">//设置串口数据位8</span></span><br><span class="line">        sp.<span class="built_in">setParity</span>(QSerialPort::NoParity);    <span class="comment">//无校验位</span></span><br><span class="line">        sp.<span class="built_in">setStopBits</span>(QSerialPort::OneStop);   <span class="comment">//1位停止位</span></span><br><span class="line">        sp.<span class="built_in">setFlowControl</span>(QSerialPort::NoFlowControl);</span><br><span class="line">        <span class="comment">//打开串口</span></span><br><span class="line">        <span class="keyword">if</span>(!sp.<span class="built_in">open</span>(QIODevice::ReadWrite))</span><br><span class="line">        &#123;</span><br><span class="line">            QMessageBox::<span class="built_in">critical</span>(<span class="literal">NULL</span>, <span class="string">&quot;提示&quot;</span>, <span class="string">&quot;串口打开失败&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            timer_id = <span class="keyword">this</span>-&gt;<span class="built_in">startTimer</span>(<span class="number">1000</span>/HEARTBEAT_FEQ,Qt::CoarseTimer); <span class="comment">//循环发送地面站信息</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;ui-&gt;com_ctrl-&gt;<span class="built_in">setText</span>(<span class="string">&quot;关闭串口&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>-&gt;ui-&gt;com_ctrl-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">this</span>-&gt;ui-&gt;com_ctrl-&gt;<span class="built_in">setEnabled</span>(<span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//关闭串口</span></span><br><span class="line">        sp.<span class="built_in">close</span>();</span><br><span class="line">        <span class="keyword">this</span>-&gt;<span class="built_in">killTimer</span>(timer_id); <span class="comment">//关闭串口的同时也关闭定时器，失能串口发送</span></span><br><span class="line">        <span class="keyword">this</span>-&gt;ui-&gt;com_ctrl-&gt;<span class="built_in">setText</span>(<span class="string">&quot;打开串口&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="对串口数据的接收"><a href="#对串口数据的接收" class="headerlink" title="对串口数据的接收"></a>对串口数据的接收</h2><p>用QSerialPort类的成员函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">QByteArray <span class="title">QSerialPort::readAll</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>这个函数是用来把PC端串口缓冲区的所有内容取出，并返回一个QByteArray。</p>
<p>由于我们选择用自动机处理数据，那么就要<strong>把数据流逐字节读取</strong>，所以FIFO效率较高的<strong>队列</strong>是最好的选择。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;QQueue&gt;</span></span></span><br><span class="line">QQueue&lt;<span class="keyword">uint8_t</span>&gt; uartRxBuffer; <span class="comment">//是MainWindow类的私有成员</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">MainWindow::getSerialData</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">QByteArray <span class="title">rxBuffer</span><span class="params">(sp.readAll())</span></span>;</span><br><span class="line">    <span class="comment">//将readAll的数据逐个push到队尾</span></span><br><span class="line">    <span class="keyword">for</span>(QByteArray::iterator iter=rxBuffer.<span class="built_in">begin</span>();iter!=rxBuffer.<span class="built_in">end</span>();iter++)</span><br><span class="line">    &#123;</span><br><span class="line">        uartRxBuffer.<span class="built_in">push_back</span>(*iter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="有穷自动机处理"><a href="#有穷自动机处理" class="headerlink" title="有穷自动机处理"></a>有穷自动机处理</h2><p>有穷自动机共有5个部分组成：字母表（组成字符串所需的字母集合），自动机状态，转换函数（状态与状态之间的转换），初始状态和终止状态。</p>
<p>有关于<strong>正则表达式</strong>和<strong>正则表达式与自动机之间的转换</strong>可以上网搜索，在此不再赘述。</p>
<p>而代码实现有穷自动机的方法是<strong>双层switch</strong>,第一层switch代表<strong>状态</strong>，第二层switch代表<strong>输入字符</strong>。</p>
<p>代码实现如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">bool</span> <span class="title">Protocol::UARTDataHandler</span><span class="params">(QQueue&lt;<span class="keyword">uint8_t</span>&gt; &amp;rxBuf)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!rxBuf.<span class="built_in">isEmpty</span>())</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in"><span class="keyword">switch</span></span> (<span class="keyword">this</span>-&gt;automata) &#123;</span><br><span class="line">            <span class="keyword">case</span> STATE_END:</span><br><span class="line">                <span class="built_in"><span class="keyword">switch</span></span> (*(rxBuf.<span class="built_in">begin</span>())) &#123;</span><br><span class="line">                    <span class="keyword">case</span> CODE_START:</span><br><span class="line">                        <span class="keyword">this</span>-&gt;codeStart = CODE_START;</span><br><span class="line">                        <span class="keyword">this</span>-&gt;automata = STATE_TYPE;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> STATE_TYPE:</span><br><span class="line">                <span class="built_in"><span class="keyword">switch</span></span> (*(rxBuf.<span class="built_in">begin</span>())) &#123;</span><br><span class="line">                    <span class="keyword">case</span> DATA_TYPE_ANGLE:</span><br><span class="line">                        <span class="keyword">this</span>-&gt;dataType = DATA_TYPE_ANGLE;</span><br><span class="line">                        rxBuf.<span class="built_in">pop_front</span>();</span><br><span class="line">                        <span class="keyword">this</span>-&gt;automata = STATE_PAYLOAD;</span><br><span class="line">                        payloadCounter = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> STATE_PAYLOAD:</span><br><span class="line">                <span class="keyword">if</span>(payloadCounter&lt;<span class="number">12</span>)</span><br><span class="line">                &#123;</span><br><span class="line">                    ((<span class="keyword">uint8_t</span>*)(<span class="keyword">this</span>-&gt;data))[<span class="keyword">this</span>-&gt;payloadCounter] = *(rxBuf.<span class="built_in">begin</span>());</span><br><span class="line">                    payloadCounter++;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">this</span>-&gt;automata = STATE_CHECKSUM;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            <span class="keyword">case</span> STATE_CHECKSUM:</span><br><span class="line">                <span class="keyword">this</span>-&gt;isVaild = <span class="built_in">CheckChecksum</span>();</span><br><span class="line">                <span class="keyword">this</span>-&gt;automata = STATE_END;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        rxBuf.<span class="built_in">pop_front</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        isVaild = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> isVaild;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</article></div></main><div class="nav-wrap"><div class="nav"><button class="site-nav"><div class="navicon"></div></button><ul class="nav_items"><li class="nav_item"><a class="nav-page" href="/projects-works"> Projects &amp; Works</a></li></ul></div><div class="cd-top"><i class="fa fa-arrow-up" aria-hidden="true"></i></div></div><footer id="page_footer"><div class="footer_wrap"><div class="copyright">&copy;2020 - 2021 by Liu Junzhuo</div><div class="theme-info">Powered by <a target="_blank" href="https://hexo.io" rel="nofollow noopener">Hexo</a> & <a target="_blank" href="https://github.com/PhosphorW/hexo-theme-academia" rel="nofollow noopener">Academia Theme</a></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery-pjax@latest/jquery.pjax.min.js"></script><script src="/js/main.js"></script></body></html>